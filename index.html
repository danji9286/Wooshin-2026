<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>석식 신청</title>
<style>
body { text-align:center; font-family:sans-serif; margin-top:50px; }
input, button { font-size:20px; padding:10px; margin:5px; }
#message { font-size:20px; margin-top:20px; height:30px; }
.normal { color:green; }
.duplicate { color:red; }
.invalid { color:red; }
</style>
</head>
<body>

<h2>석식 신청</h2>
<input type="text" id="studentId" placeholder="학번 입력">
<button id="submitBtn">입력</button>
<div id="message"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyACMtFDfVtgHIerB_8CnqkvtRCdSP0vi68",
  authDomain: "wooshin-28cef.firebaseapp.com",
  projectId: "wooshin-28cef",
  storageBucket: "wooshin-28cef.firebasestorage.app",
  messagingSenderId: "62328740426",
  appId: "1:62328740426:web:d317327159fc67f09b64b3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const submitBtn = document.getElementById("submitBtn");
const studentInput = document.getElementById("studentId");
const messageDiv = document.getElementById("message");

// 허용 학번 배열
const allowedStudents = ["2114", "1511", "2108"];

function today() { return new Date().toISOString().split("T")[0]; }

async function submit() {
  const studentId = studentInput.value.trim();
  messageDiv.textContent="";

  if (!studentId) { 
    messageDiv.textContent="학번을 입력해주세요"; 
    messageDiv.className="invalid"; 
    return; 
  }

  const attemptRef = doc(db, "logs", today(), "attempts", studentId);
  const attemptSnap = await getDoc(attemptRef);

  if (!allowedStudents.includes(studentId)) {
    // 없는 학번 처리 → Firestore에도 기록
    await setDoc(attemptRef, { count:1, type:"invalid" });
    messageDiv.textContent="등록되지 않은 학번"; 
    messageDiv.className="invalid"; 
    studentInput.value="";
    return;
  }

  if (!attemptSnap.exists()) {
    // 처음 입력 → 정상
    await setDoc(attemptRef, { count:1, type:"정상" });
    messageDiv.textContent="정상 입력"; 
    messageDiv.className="normal";
  } else {
    // 이미 입력 → 중복 처리
    const prevCount = attemptSnap.data().count || 1;
    await setDoc(attemptRef, { count: prevCount + 1, type:"duplicate" });
    messageDiv.textContent="이미 입력함"; 
    messageDiv.className="duplicate";
  }

  studentInput.value="";
}

submitBtn.addEventListener("click", submit);
studentInput.addEventListener("keypress", e => { if(e.key==="Enter") submit(); });

</script>

</body>

</html>


