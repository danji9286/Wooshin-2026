<!DOCTYPE html>
<html>
<head>
<title>관리자</title>

<style>

body {
  font-family: sans-serif;
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#login {
  text-align: center;
}

#admin {
  display: none;
  width: 100%;
  max-width: 900px;
  margin: auto;
}

section {
  margin-top: 20px;
}

h2 {
  border-bottom: 2px solid black;
}

li {
  font-size: 20px;
}

button, input {
  font-size: 20px;
  padding: 10px;
  margin: 5px;
}

</style>

</head>

<body>

<!-- 로그인 화면 -->

<div id="login">

<h2>관리자 비밀번호</h2>

<input type="password" id="pw"
onkeydown="if(event.key==='Enter') login()">

<br>

<button onclick="login()">확인</button>

<p id="loginMsg"></p>

</div>

<!-- 관리자 화면 -->

<div id="admin">

<h1>석식 관리자</h1>

<button onclick="load()">새로고침</button>
<button onclick="reset()">오늘 기록 초기화</button>

<section>
<h2>정상 입장</h2>
<ul id="normal"></ul>
</section>

<section>
<h2>중복 입력</h2>
<ul id="duplicate"></ul>
</section>

<section>
<h2>없는 학번</h2>
<ul id="invalid"></ul>
</section>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyACMtFDfVtgHIerB_8CnqkvtRCdSP0vi68",
  authDomain: "wooshin-28cef.firebaseapp.com",
  projectId: "wooshin-28cef",
  storageBucket: "wooshin-28cef.firebasestorage.app",
  messagingSenderId: "62328740426",
  appId: "1:62328740426:web:d317327159fc67f09b64b3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PASSWORD = "0105";

function today() {
  return new Date().toISOString().split("T")[0];
}

window.login = function() {

  const pw = document.getElementById("pw").value;

  if (pw === PASSWORD) {

    document.getElementById("login").style.display = "none";
    document.getElementById("admin").style.display = "block";

    document.body.style.alignItems = "flex-start";
    document.body.style.padding = "20px";

    load();

  } else {
    document.getElementById("loginMsg").innerText = "비밀번호 틀림";
  }
};

window.load = async function() {

  ["normal", "duplicate", "invalid"].forEach(id => {
    document.getElementById(id).innerHTML = "";
  });

  const snap = await getDocs(
    collection(db, "logs", today(), "attempts")
  );

  snap.forEach(d => {

    const data = d.data();

    const li = document.createElement("li");
    li.textContent = d.id + " (" + data.count + "회)";

    document.getElementById(data.type).appendChild(li);

  });
};

window.reset = async function() {

  if (!confirm("오늘 기록 초기화?")) return;

  const snap = await getDocs(
    collection(db, "logs", today(), "attempts")
  );

  for (const d of snap.docs) {
    await deleteDoc(d.ref);
  }

  alert("초기화 완료");
  load();
};

</script>

</body>
</html>