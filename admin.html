<!DOCTYPE html>
<html>
<head>
<title>석식 관리자</title>
<style>
body { font-family:sans-serif; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
h1 { margin-bottom:20px; }
section { margin-top:20px; }
h2 { border-bottom:2px solid black; }
li { font-size:20px; }
button { font-size:20px; padding:10px; margin-right:10px; }
#adminPanel { display:none; }
input { font-size:20px; padding:10px; margin-right:10px; }
</style>
</head>
<body>

<h1>석식 관리자</h1>

<!-- 로그인 화면 -->
<div id="loginSection">
  <input type="password" id="adminPw" placeholder="비밀번호">
  <button id="loginBtn">입장</button>
</div>

<!-- 관리자 화면 -->
<div id="adminPanel">
  <button onclick="load()">새로고침</button>
  <button onclick="reset()">오늘 기록 초기화</button>

  <section>
    <h2>정상 입장</h2>
    <ul id="normal"></ul>
  </section>

  <section>
    <h2>중복 입력</h2>
    <ul id="duplicate"></ul>
  </section>

  <section>
    <h2>없는 학번</h2>
    <ul id="invalid"></ul>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyACMtFDfVtgHIerB_8CnqkvtRCdSP0vi68",
  authDomain: "wooshin-28cef.firebaseapp.com",
  projectId: "wooshin-28cef",
  storageBucket: "wooshin-28cef.firebasestorage.app",
  messagingSenderId: "62328740426",
  appId: "1:62328740426:web:d317327159fc67f09b64b3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const adminPassword = "0105";
const loginBtn = document.getElementById("loginBtn");
const adminPw = document.getElementById("adminPw");
const adminPanel = document.getElementById("adminPanel");
const loginSection = document.getElementById("loginSection");

function today(){ return new Date().toISOString().split("T")[0]; }

// 로그인 처리
loginBtn.addEventListener("click", login);
adminPw.addEventListener("keypress", e => { if(e.key==="Enter") login(); });

function login(){
  if(adminPw.value === adminPassword){
    adminPw.value="";
    loginSection.style.display="none";
    adminPanel.style.display="block";
    load();
  } else {
    alert("비밀번호 틀림");
  }
}

// 기록 불러오기
window.load = async function(){
  ["normal","duplicate","invalid"].forEach(id=>document.getElementById(id).innerHTML="");

  const snap = await getDocs(collection(db,"logs",today(),"attempts"));
  snap.forEach(d=>{
    const data=d.data();
    const li=document.createElement("li");
    li.textContent=d.id+" ("+data.count+"회)";
    
    // Firestore에 저장된 type이 '정상'/'duplicate'/'invalid'로 들어와야 정상 표시
    if(data.type==="정상") document.getElementById("normal").appendChild(li);
    else if(data.type==="duplicate") document.getElementById("duplicate").appendChild(li);
    else document.getElementById("invalid").appendChild(li);
  });
};

// 초기화
window.reset = async function(){
  if(!confirm("오늘 기록 초기화?")) return;
  const snap = await getDocs(collection(db,"logs",today(),"attempts"));
  for(const d of snap.docs) await deleteDoc(d.ref);
  alert("초기화 완료");
  load();
};
</script>

</body>
</html>